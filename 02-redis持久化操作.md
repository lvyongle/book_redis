# redis持久化操作

### 持久化操作简介

- 数据快照方式-RDB
- 过程日志方式-AOF



### RDB方式存储方式

方法一:

- 指令方式
  - `save`  : 执行一次,保存一次
  - 查看文件位置  `CONFIG GET DIR`
- save指令相关配置
  - `dbfilename` 
    - 保存文件名
    - 默认 `dump.rdb`
    - 通常设置 `dump[-端口号].rdb`
  - `dir`
    - 存储 `.rdb` 文件的路径
    - 通常使用最大盘
  - `rdbcompression` 
    - 设置存储本地数据库时是否压缩数据,默认 `yes` ,采用 `LZF` 压缩
    - 通常默认开启,如果设置为 `no` ,可节省 ` cpu ` 性能,但会使文件变得巨大
  - `rdbchecksum`
    - 校验 ` RDB ` 文件
    - 每次变更操作都会降低性能,但是建议打开
- 性能问题
  - 由于redis是单进程服务器,所以当执行 `save` 指令的时候,会出现性能阻塞,所以一般不建议线上使用该指令



方法二:

- 指令方式
  - `bgsave` :后台指令
    - 调用函数  `forck()` 启动一个线程 ,后台执行数据备份操作
    - 备份完成返回消息
- `bgsave` 指令相关配置
  - `stop-writes-on-bgsave-error` 
    - 后台存储过程中出现错误,停止操作
    - 默认开启



方式三:

- 启动方式
- 参数配置
  - `save second changes`
    - 在满足时间范围内`key` 的变化数量达到指定数量就进行持久化
    - `second` 监控时间
    - `changes` 监控`key` 的变化数量



`RDB` 三种启动方式对比

| 方式           | `save`指令 | `bgsave`指令 |
| -------------- | ---------- | ------------ |
| 读写           | 同步       | 异步         |
| 阻塞客户端指令 | 是         | 否           |
| 额外内存消耗   | 否         | 是           |
| 启动新进程     | 否         | 是           |



`rdb` 特殊启动形式

- 全量复制

- 服务器运行过程中重启

  ```shell
  debug reload
  ```

- 关闭服务器时指定保存数据

  ```shell
  shutdown save
  ```

  

`RDB` 优缺点

- 优点
  - 紧凑的二进制文件,存储效率高
  - 内部存储的时redis某个时间点的数据快照,非常适合数据备份,全量复制等场景
  - 回复速率比`AOF`快很多
  - 应用:定时进行`bgsave` ,并将文件拷贝到远程机器中,用于灾难恢复
- 缺点
  - 无法进行实时持久化,有较大可能丢失数据
  - bgsave每次都要调用`fork`创建子进程,会消耗性能
  - 众多`REDIS`版本,RDB文件可能会出现数据无法兼容的情况







### `AOF` 方式存储

`RDB` 存储弊端

- 存储数据量大,效率低
  - 基于快照思想,每次都是全量
- 大数据量下的IO性能较低
- 基于`fork` 创建子进程,内存产生额外消耗
- 宕机带来的数据丢失风险



> 需要开启 `AOF` 
>
> ```
> appendonly yes
> ```
>
> 

`AOF` 写数据三种策略(appendfsync)

- always(每次)
  - 每次写入操作同步到`AOF`文件中,数据零误差,性能较低
- everysec(每秒)
  - 每秒缓冲区的指令同步到`AOF` 文件中,准确性较高,性能较高,在系统宕机情况下,会丢失1s数据
- no(系统控制)
  - 由系统控制,整体过程不可控



`AOF` 相关配置

- `appendfilename` 
  - 持久化文件名
  - 建议`appendonly[-端口号].aof` 
- `dir`
  - `AOF` 文件按存储路径
  - 与`RDB` 文件保存一致即可



`AOF`重写操作

- 作用
  - 降低磁盘使用量
  - 提高持久化效率,降低持久化写时间
  - 降低数据恢复时,提高数据恢复效率
- 规则
  - 进程里已超时,不再重写
  - 忽略无效指令
  - 对同一数据多条写命令合并



`AOF`重写方式

- 手动重写

  - `bgrewriteaof`

- 自动重写

  ```
  auto-aof-rewrite-min-size size
  auto-aof-rewrite-percentage percentage
  ```

  





